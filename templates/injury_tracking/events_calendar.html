{% extends 'base.html' %}
{% block title %}Team Events Calendar{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Team Events</h2>
    <a href="{% url 'tracking:event_create' %}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-1"></i>New Event
    </a>
  </div>
  <div class="card">
    <div class="card-body">
      <div id="calendar"></div>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col-lg-6">
      <div class="alert alert-info">
        <strong>Tip:</strong> Drag-select on the calendar to quickly create an event.
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Upcoming Events</div>
        <div class="card-body p-0">
          {% if upcoming_events %}
            <ul class="list-group list-group-flush">
              {% for ev in upcoming_events %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">{{ ev.get_event_type_display }}: {{ ev.title }}</div>
                    <small class="text-muted">{{ ev.start_datetime }} – {{ ev.end_datetime }}</small>
                  </div>
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'tracking:event_detail' ev.id %}">View</a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="p-3 text-muted">No upcoming events.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      nowIndicator: true,
      navLinks: true,
      selectable: true,
      selectMirror: true,
      displayEventTime: true,
      select: function(info) {
        const start = info.startStr;
        const end = info.endStr;
        const title = prompt('Event title (optional):');
        const url = new URL('{% url "tracking:event_create" %}', window.location.origin);
        url.searchParams.set('start', start);
        url.searchParams.set('end', end);
        if (title) url.searchParams.set('title', title);
        window.location.href = url.toString();
      },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: {
        url: '{% url "tracking:events_feed" %}',
        method: 'GET',
        failure: function() {
          alert('There was an error while fetching events!');
        }
      },
      eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: 'short' },
      eventContent: function(arg) {
        // Build: [badge] Bold title (no leading whitespace to avoid stray glyphs)
        const type = arg.event.extendedProps.type;
        const container = document.createElement('div');
        container.className = 'fc-event-custom';
        const badge = document.createElement('span');
        badge.className = 'badge rounded-pill bg-primary me-1';
        badge.textContent = type;
        const title = document.createElement('strong');
        title.className = 'fc-event-title-strong ms-1';
        title.textContent = arg.event.title;
        container.appendChild(badge);
        container.appendChild(title);
        return { domNodes: [container] };
      },
      eventDidMount: function(info) {
        // Tooltip with type, title, time range, location
        const start = info.event.start;
        const end = info.event.end;
        const opts = { hour: '2-digit', minute: '2-digit' };
        const time = start && end ? `${start.toLocaleTimeString([], opts)}–${end.toLocaleTimeString([], opts)}` : '';
        const location = info.event.extendedProps.location;
        const tip = `${info.event.extendedProps.type}: ${info.event.title}\n${time}${location ? `\n@ ${location}` : ''}`;
        info.el.setAttribute('title', tip);
      },
      eventClick: function(info) {
        if (info.event.url) {
          window.location.href = info.event.url;
          info.jsEvent.preventDefault();
        }
      }
    });
    calendar.render();
  });
</script>
<style>
  /* Tighten event appearance and avoid stray underline/glyphs from leading spaces */
  .fc .fc-event-custom .badge { font-size: 0.65rem; line-height: 1; padding: .35em .5em; }
  .fc .fc-event-title-strong { font-weight: 600; }
  /* Remove default title spacing that can show tiny artifacts when using custom content */
  .fc .fc-daygrid-event .fc-event-title { display: none; }
  /* Keep the time (if present) but reduce its margin */
  .fc .fc-daygrid-event .fc-event-time { margin-right: .25rem; }
  /* Prevent long titles from pushing a tiny wrap artifact */
  .fc .fc-daygrid-event .fc-event-main { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
{% endblock %}


