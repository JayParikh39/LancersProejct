{% extends 'base.html' %}
{% load static %}

{% block title %}Injury Records - Lancer Injury Tracking{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="widget-icon primary me-3">
                <i class="bi bi-clipboard-data"></i>
              </div>
              <div>
                <h1 class="card-title mb-1">Injury Records</h1>
                <p class="text-muted mb-0">Comprehensive injury tracking and management</p>
              </div>
            </div>
            {% if user.role == 'DOCTOR' or user.role == 'ADMIN' %}
            <a href="{% url 'tracking:injury_create' %}" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>Report New Injury
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-funnel me-2"></i>Search & Filter
          </h5>
        </div>
        <div class="card-body">
          <form method="get" class="row g-3">
            <div class="col-md-3">
              <label for="{{ search_form.player.id_for_label }}" class="form-label">Player</label>
              {{ search_form.player }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.injury_type.id_for_label }}" class="form-label">Injury Type</label>
              {{ search_form.injury_type }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.body_part.id_for_label }}" class="form-label">Body Part</label>
              {{ search_form.body_part }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.severity.id_for_label }}" class="form-label">Severity</label>
              {{ search_form.severity }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.status.id_for_label }}" class="form-label">Status</label>
              {{ search_form.status }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.date_from.id_for_label }}" class="form-label">From Date</label>
              {{ search_form.date_from }}
            </div>
            <div class="col-md-3">
              <label for="{{ search_form.date_to.id_for_label }}" class="form-label">To Date</label>
              {{ search_form.date_to }}
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="btn-group w-100" role="group">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search me-1"></i>Search
                </button>
                <a href="{% url 'tracking:injury_list' %}" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-clockwise me-1"></i>Reset
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="row">
    <div class="col-12">
      <!-- CSRF token for JavaScript POST requests -->
      {% csrf_token %}
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-list-ul me-2"></i>Injury Records
            <span class="badge bg-primary ms-2">{{ page_obj.paginator.count }} Total</span>
          </h5>
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
              <i class="bi bi-download me-1"></i>Export
            </button>
            {% if user.role == 'ADMIN' %}
            <a href="/admin/injury_tracking/injuryrecord/" class="btn btn-outline-warning btn-sm">
              <i class="bi bi-gear me-1"></i>Admin
            </a>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% if injuries %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Player</th>
                    <th>Injury Type</th>
                    <th>Body Part</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Injury Date</th>
                    <th>Reported By</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for injury in injuries %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                          {{ injury.player.first_name|first|upper }}{{ injury.player.last_name|first|upper }}
                        </div>
                        <div>
                          <div class="fw-bold">{{ injury.player.get_full_name }}</div>
                          <small class="text-muted">{{ injury.player.team.name }}</small>
                        </div>
                      </div>
                    </td>
                    <td>{{ injury.injury_type.name }}</td>
                    <td>{{ injury.body_part.name }}</td>
                    <td>
                      <span class="badge" style="background-color: {{ injury.severity.color_code }}; color: white;">
                        {{ injury.severity.name }}
                      </span>
                    </td>
                    <td>
                      <span class="status-badge status-{{ injury.status|lower }}">
                        {{ injury.get_status_display }}
                      </span>
                    </td>
                    <td>{{ injury.injury_date|date:"M d, Y" }}</td>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-secondary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; font-size: 12px;">
                          {{ injury.reported_by.first_name|first|upper }}{{ injury.reported_by.last_name|first|upper }}
                        </div>
                        <div>
                          <div class="fw-bold small">{{ injury.reported_by.get_full_name }}</div>
                          <small class="text-muted">{{ injury.reported_by.get_role_display }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <a href="{% url 'tracking:injury_detail' injury.pk %}" class="btn btn-outline-primary btn-sm" title="View Details">
                          <i class="bi bi-eye"></i>
                        </a>
                        {% if user.role == 'DOCTOR' or user.role == 'ADMIN' %}
                        <a href="{% url 'tracking:injury_update' injury.pk %}" class="btn btn-outline-warning btn-sm" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        {% if injury.status != 'RECOVERED' %}
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="markAsRecovered({{ injury.pk }}, '{{ injury.player.get_full_name }}')" 
                                title="Mark as Recovered">
                          <i class="bi bi-check-circle"></i>
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="deleteInjury({{ injury.pk }}, '{{ injury.player.get_full_name }}')" 
                                title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Injury records pagination">
              <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                      <i class="bi bi-chevron-double-left"></i>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                      <i class="bi bi-chevron-left"></i>
                    </a>
                  </li>
                {% endif %}

                <li class="page-item active">
                  <span class="page-link">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                  </span>
                </li>

                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                      <i class="bi bi-chevron-right"></i>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                      <i class="bi bi-chevron-double-right"></i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-clipboard-data text-muted" style="font-size: 4rem;"></i>
              <h4 class="text-muted mt-3">No injuries found</h4>
              <p class="text-muted">No injury records match your search criteria.</p>
              {% if user.role == 'DOCTOR' or user.role == 'ADMIN' %}
              <a href="{% url 'tracking:injury_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Report First Injury
              </a>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function exportData() {
    // Get current search parameters
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    
    // Create download link
    const exportUrl = `${window.location.pathname}?${params.toString()}`;
    window.open(exportUrl, '_blank');
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function getCsrfToken() {
    // Try to get CSRF token from cookie (Django's default)
    const token = getCookie('csrftoken');
    if (token) return token;
    
    // Fallback: look for token in hidden input or meta tag
    const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (tokenInput) return tokenInput.value;
    
    const metaToken = document.querySelector('meta[name=csrf-token]');
    if (metaToken) return metaToken.content;
    
    return null;
  }

  function markAsRecovered(injuryId, playerName) {
    if (confirm(`Mark injury for ${playerName} as recovered with medical clearance?`)) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/tracking/injuries/${injuryId}/recover/`;
      form.style.display = 'none';
      
      const csrfToken = getCsrfToken();
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
      }
      
      document.body.appendChild(form);
      form.submit();
    }
  }

  function deleteInjury(injuryId, playerName) {
    if (confirm(`Are you sure you want to delete the injury record for ${playerName}?\n\nThis action cannot be undone.`)) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/tracking/injuries/${injuryId}/delete/`;
      form.style.display = 'none';
      
      const csrfToken = getCsrfToken();
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
      }
      
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>

<style>
  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .status-active {
    background-color: #fef3c7;
    color: #92400e;
  }
  
  .status-recovering {
    background-color: #dbeafe;
    color: #1e40af;
  }
  
  .status-recovered {
    background-color: #d1fae5;
    color: #065f46;
  }
  
  .status-chronic {
    background-color: #fee2e2;
    color: #991b1b;
  }
  
  .avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 14px;
    font-weight: 600;
  }
</style>
{% endblock %}
